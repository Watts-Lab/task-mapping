---
title: "Task mapping data preperation"
---

```{r}
library(tidyverse)
library(irr)
library(ggplot2)
library(jsonlite)
library(graphics)
library(ggfortify)
library(stats)
library(ggpubr)
```

```{r}
# These read from our glitch server. If they are not working, double check that it is live by visiting https://task-robot.glitch.me 
# The server should wake up after the first call, so just running this block twice should get the data on a fresh launch.

# A table of all responses to the task mapping survey (notably this includes agreement instances as well as individual responses)
raw_responses <- fromJSON("https://task-robot.glitch.me/results/survey/json")

# All the tasks that are in our mapping google sheet
tasks <- fromJSON("https://task-robot.glitch.me/tasks/json")

# All the questions asked in the mapping process
questions <- fromJSON("https://task-robot.glitch.me/questions/json")
```


```{r}
ordinals <-
  questions %>% filter(answer_type == "ordinal", focus == "task") %>%
  inner_join(data.frame(name = raw_responses %>% names())) %>%
  mutate(levels = strsplit(answer_choices, " \\| ")) %>%
  select(name, levels, focus)

clean_responses <- raw_responses %>%
  select(-platform, -createdAt, -`_id`) %>%
  mutate(
    across(# this sets our variables to the right type
      ordinals$name,
      ~ ordered(., levels = (
        ordinals %>% filter(name == cur_column())
      )$levels[[1]])),
    user = trimws(gsub(
      "  ", " ",
      
      gsub(
        "( and |, |&|\\/|;)",
        " \\| ",
        gsub(
          "(Subramaniam|Bottcher|Sampath|Cullen|Balasubramanian)",
          "",
          gsub(
            "sarikasu",
            "Sarika",
            gsub(
              "(katelynbottcher|Katelynn)",
              "Katelyn",
              gsub("KaranSampath", "Karan", user)
            )
          )
        )
      )
    )),
    stage = case_when(# lets us know which tasks have agreement
      grepl("\\|", user) ~ "agreement",
      TRUE ~ "individual"),
    name_clean = trimws(gsub("  ", " ",
                             gsub(
                               ".md", "",
                               gsub(
                                 "contruction",
                                 "construction",
                                 gsub("judgement", "judgment",
                                      gsub(
                                        "and slogan",
                                        "slogan",
                                        gsub(
                                          "finding the maximum",
                                          "find the maximum",
                                          gsub(
                                            "recall associations",
                                            "recall association",
                                            gsub("husband ", "husbands ",
                                                 gsub(
                                                   "nine", "9",
                                                   gsub("suduko", "sudoku",
                                                        sub(
                                                          "task", "",
                                                          gsub("various versions", "",
                                                               gsub(
                                                                 "hidden profile", "",
                                                                 gsub("[()-]", " ",
                                                                      tolower(task))
                                                               ))
                                                        ))
                                                 ))
                                          )
                                        )
                                      ))
                               )
                             ))),
    performance_all = paste(performance_all, sep = ", ")
  ) %>%
  left_join(tasks %>% mutate(name_clean = trimws(gsub(
    "  ", " ",
    sub("(anagrams)", "",
        sub(
          "task", "",
          gsub(" and its variants", "",
               gsub(
                 "and slogan", "slogan",
                 gsub("various versions", "",
                      gsub(
                        "hidden profile", "",
                        gsub("[\"()-]", " ",
                             tolower(name))
                      ))
               ))
        ))
  ))) %>% select(name, name_clean)) %>%
  mutate(task = name) %>%
  select(task, stage, user, updatedAt , everything())

unrecognised_tasks <-
  clean_responses %>% select(task, name_clean) %>% filter(is.na(task)) %>% arrange(name_clean)

if ((unrecognised_tasks %>% dim())[[1]] > 0)
  stop("Error, some task names did not match:\n\n",
       unrecognised_tasks)
```

```{r}
# Store the main tables to csv so other people can use them.
agreed_responses <- clean_responses %>%
  filter(stage == "agreement") %>% 
  select(-stage,-user,-updatedAt) %>%
  arrange(task)

agreed_responses %>% 
  write_csv("../task_map.csv")

questions %>% 
  select(name,text,focus,answer_choices,answer_type,source) %>% 
  arrange(name) %>% 
  write_csv("../questions.csv")

clean_responses %>% arrange(task,updatedAt)

# Alsmost complete tasks
clean_responses %>% 
  group_by(task,stage) %>% 
  summarise(mappers=paste(user, collapse = ' & ')) %>% 
  pivot_wider(names_from = stage, values_from = mappers) %>% 
  filter(is.na(agreement)) %>%
  select(-agreement) %>%
  rename(mappers_so_far = individual) %>% 
  arrange(task)
```

```{r}
# Initial analysis that might move to another file at a later point
numerical_responses_matrix <- agreed_responses %>% 
  select(task,ordinals$name) %>% 
  column_to_rownames(var = "task") %>% 
  mutate(across(everything(),~ if_else(is.na(as.numeric(.)),0,as.numeric(.))))

pca = prcomp(~., data = numerical_responses_matrix,na.action = na.exclude)
summary(pca)
plot(pca)
biplot(pca,var.axes = FALSE,)

# Methods from https://cran.r-project.org/web/packages/ggfortify/vignettes/plot_pca.html 
autoplot(pca,
         data = numerical_responses_matrix,
         shape = FALSE,
         label.size = 3) +
  labs(title = paste("PCA of mapped tasks (across",dim(numerical_responses_matrix)[[2]],"task features and",dim(numerical_responses_matrix)[[1]],"tasks)",sep = " "), x = "", y = "") + 
  ggpubr::theme_pubclean()
ggsave("Mapped_task_PCA.png",
       width = 7,
       height = 5) 
```

```{r}
task_names <- agreed_responses$task
```

```{r}
# heatmap
heatmap_matrix <- as.matrix(numerical_responses_matrix)

png("heatmap.png", width = 20, height = 20, units = 'in', res = 600)
heatmap <- heatmap(heatmap_matrix, Colv = NA) #Row dendrogram groups this by similarity in rows
```

```{r}
# k-means clustering
# source: https://www.datanovia.com/en/blog/k-means-clustering-visualization-in-r-step-by-step-guide/

# Compute k-means with k = 3
set.seed(123)
res.km <- kmeans(numerical_responses_matrix, 4, nstart = 100)
# K-means clusters showing the group of each individuals
res.km$cluster

task_clusters <- as.data.frame(cbind(task_names, res.km$cluster))

task_clusters[order(task_clusters$V2),]



# Dimension reduction using PCA
res.pca <- prcomp(numerical_responses_matrix)
# Coordinates of individuals
ind.coord <- as.data.frame(get_pca_ind(res.pca)$coord)
# Add clusters obtained using the K-means algorithm
ind.coord$cluster <- factor(res.km$cluster)

ind.coord$lbl <- c(1:50)
# Data inspection
head(ind.coord)


ggscatter(
  ind.coord, x = "Dim.1", y = "Dim.2", 
  color = "cluster", palette = "npg", ellipse = TRUE, ellipse.type = "convex",
  label = ind.coord$lbl
) +
  stat_mean(aes(color = cluster), size = 4)
ggsave("Mapped_task_PCA_Clustered_Colored_4.png",
       width = 7,
       height = 6) 
```


