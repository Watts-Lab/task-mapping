---
title: "new-task-writeup-viz-pipeline"
author: "Emily Hu"
date: "2/27/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(corrplot)
library(irr)
library(stringr)
library(markdown)
library(qualtRics)
library(ggplot2)
library(dplyr)
library(tidyverse)
```

# Basic setup
(Not pushed to GitHub)

# Pull in Survey Data
```{r}
surveys <- all_surveys()

task_writing_survey_id <- surveys$id[2]

df.survey_results <- fetch_survey(
  surveyID = task_writing_survey_id,
  save_dir = ".",
  force_request = T
)
```

# Check timing
```{r}
df.survey_results %>%
  mutate(
    Duration = EndDate-StartDate
  ) %>%
  summarize(
    medianDuration = median(Duration)
  )
```

```{r}
colnames(df.survey_results)

df.survey_results_cleaned <-df.survey_results %>%
  select(
    `task-name`,
    `GitHub-id`,
    `stimulus-complex`,
    `goal-directives`,
    skills,
    `ui-ux`,
    `allowed-gr-proc`,
    `GitHub-link`,
    `external-resources`
  )

df.survey_results_cleaned
```

# Generate .md Files
```{r}
for(i in 1:nrow(df.survey_results_cleaned)){
  row <- df.survey_results_cleaned[i,]
  task_title <- paste0("# ",toString(row$`task-name`),"\n\n")
  author <- paste0("Mapped by: ",toString(row$`GitHub-id`)," \n\n")
  stim_complex <- paste0("## 1. Stimulus Complex \n",toString(row$`stimulus-complex`),"\n\n")
  goal_directives <- paste0("## 2. Goal Directives \n",toString(row$`goal-directives`),"\n\n")
  allowed_group_processes <- "## 3. Allowed Group Processes \n" 
  group_proc_info <- "The following details are not the main parts of the task, but rather additional information about ways in which participants could interact.\n\n"
  skills <- paste0("### Skills \n",toString(row$`skills`),"\n\n")
  uiux <- paste0("### UI-UX Allowed Processes\n",toString(row$`ui-ux`),"\n\n")
  other_allowed_proc <- paste0("### Other Allowed Processes\n",toString(row$`allowed-gr-proc`),"\n\n")
  github <- paste0("## GitHub Link \n",toString(row$`GitHub-link`))

  total_markdown_string <- paste0(task_title,
                                  author,
                                  stim_complex,
                                  goal_directives,
                                  allowed_group_processes,
                                  group_proc_info,
                                  skills,
                                  uiux,
                                  other_allowed_proc,
                                  github)
  
  file_title <- paste0("../tasks/summaries/",row$`task-name`,"-writeup.md")
  
  # only write the file if it doesn't already exist
  if(file.exists(file_title) == FALSE){
    writeup_file <- file(file_title, "w") # Create Rmarkdown file
    cat(total_markdown_string, file = writeup_file) # Write your content to Rmarkdown file
    close(writeup_file)
  }
}
```

# Generate a CSV with task names in one column and HTML in a second column
This will enable us to paste directly into the task mapping survey.
```{r}
df.task_map_format <- data.frame(matrix(ncol = 2, nrow = 0))
colnames(df.task_map_format) <- c('Task Name', 'Task Writeup')

for(i in 1:length(df.survey_results$`task-name`)){
  task_name <- df.survey_results$`task-name`[i]
  file_title <- paste0("../tasks/summaries/",task_name,"-writeup.md")
  
  txt <- read_file(file_title)
  txt_html <- markdownToHTML(text = txt,
                             fragment.only =  T)
  
  # remove the mapper name and the github link
  txt_html <- str_remove(txt_html, "<p>Mapped by: .*</p>") %>%
      str_remove("<h2>.*GitHub Link.*") %>%
      str_remove("<a href=.*</a>") %>%
      str_remove("<p></p>")
  
  # remove line breaks
  txt_html <- str_replace_all(txt_html, "[\r\n]" , "")
  
  # add better line breaks
  txt_html <- str_replace_all(txt_html, "<h2>", "<br><h2>") %>%
              str_replace_all("<h1>", "<h2>") %>%
              str_replace_all("</h1>", "</h2>")
  
  new_row = data.frame(
    'Task Name'= task_name,
    'Task Writeup' =  txt_html
  )
  
  df.task_map_format <- rbind(df.task_map_format, new_row)
}
```


```{r}
df.task_map_format %>% write_csv('./html/task-htmls.csv')
```


# Look at Survey Results

Get a mapping of the task name to the loop numbers
```{r}
df.task_name_to_index <- cbind(df.survey_results$`task-name`, rep(1:length(df.survey_results$`task-name`))) %>%
                                as.data.frame() %>%
                                rename(
                                  task_name = V1,
                                  task_num = V2
                                ) %>%
                                mutate(
                                  task_num = strtoi(task_num)
                                )
```

Get survey data
```{r}
task_mapping_survey_id <- surveys$id[3]

df.task_map <- fetch_survey(
  surveyID = task_mapping_survey_id,
  save_dir = ".",
  force_request = TRUE
)

df.task_map
```

Names of the questions
```{r}
# Question names
main_questions <- c(
  "Q1concept_behav",
  "Q2intel_manip_1",
  "Q3type_1_planning",
  "Q4type_2_generate",
  "Q5creativity_input_1",
  "Q6type_5_cc",
  "Q7type_7_battle",
  "Q8type_8_performance",
  "Q9divisible_unitary",
  "Q10maximizing",
  "Q11optimizing",
  "Q13outcome_multip",
  "Q14sol_scheme_mul",
  "Q15dec_verifiability",
  "Q16shared_knowledge",
  "Q17within_sys_sol",
  "Q18sol_eureka",
  "Q19time_solvability",
  "Q20type_3_type_4",
  "Q21intellective_judg_1",
  "Q22confl_tradeoffs",
  "Q23ss_out_uncert"
)

feedback_questions <- c(
  "Q1concept_beh_feedbk",
  "Q2intel_manip_fdbk",
  "Q3type_1_feedback",
  "Q4type_2_feedbck",
  "Q5creativity_feedbck",
  "Q6type_5_feedback",
  "Q7type_7_feedback",
  "Q8type_8_feedback",
  "Q9div_unitary_feedbk",
  "Q10maximizing_feedbk",
  "Q11optimizing_feedbk",
  "Q13out_mult_feedbk",
  "Q14sol_s_mult_fdbk",
  "Q15d_verif_feedbk",
  "Q16shared_kno_feedbk",
  "Q17within_sys_feedbk",
  "Q18sol_eureka_feedbk",
  "Q19time_solv_feedbk",
  "Q20type_3_4_feedbk",
  "Q21int_jud_feedbk",
  "Q22con_trade_feedbk",
  "Q23ss_outc_u_feedbk"
)

confidence_questions <- c(
  "Q1concept_beh_conf",
  "Q2intel_manip_conf",
  "Q3type_1_conf",
  "Q4type_2_conf",
  "Q5creativity_conf",
  "Q6_type_5_conf",
  "Q7type_7_conf",
  "Q8_type_8_conf",
  "Q9div_unitary_conf",
  "Q10maximizing_conf",
  "Q11optimizing_conf",
  "Q13out_mult_conf",
  "Q14sol_s_mult_conf",
  "Q15d_verif_conf",
  "Q16shared_kno_conf",
  "Q17within_sys_conf",
  "Q18sol_eureka_conf",
  "Q19time_solv_conf",
  "Q20type_3_4_conf",
  "Q21int_jud_conf",
  "Q22con_trade_conf",
  "Q23ss_out_u_conf"
)

# For getting median time
# %>% 
#   mutate(
#     Duration = EndDate-StartDate
#   ) %>%
#   summarize(
#     medianDuration = median(Duration)
#   )
#   
```

Gather all of the raw ratings

```{r}
df.all_ratings_raw <- df.task_map %>%
  select(matches('[0-9]')) %>%
  mutate(across(everything(), as.character)) %>%
  pivot_longer(
    cols = everything(),
    names_sep = 2,
    names_to = c("task_num", "question_name")
  ) %>%
  mutate(
    task_num = strtoi(gsub("[^0-9]", "", task_num)),
    question_name = str_extract(question_name, "Q[0-9].*")
  ) %>% 
  drop_na() %>%
  group_by(task_num) %>%
  inner_join(df.task_name_to_index,
            by = "task_num")
```

# Get number of ratings so far
```{r}
df.all_ratings_raw %>%
  filter(question_name == "Q1concept_behav") %>%
  ungroup() %>%
  select(task_name) %>%
  table()
```


Looking at inter-rater reliability

```{r}
# main summary stats
df.main_questions_summary <- df.all_ratings_raw %>%
  filter(question_name %in% main_questions) %>%
  filter(question_name != 'Q2intel_manip_1' & 
            question_name != 'Q21intellective_judg_1' &
            question_name != 'Q5creativity_input_1') %>%
  mutate(value = recode(value, 
                     "Mental" = 0,
                     "Physical" = 1,
                     "Not applicable or not answerable based on the task description (Please Elaborate Below.)" = 3,
                     "No" = 0,
                     "Yes" = 1
                   )) %>%
  filter(value != 3) %>% # remove cases in which people thought it wasn't answerable - for now
  group_by(task_name,question_name) %>%
  summarize(mean_rating = mean(value),
            n_labels = agree(t(value))$raters,
            all_values = paste(value, collapse = " & "),
            # TODO - this is a manual way of calculating percent agreement
            agreement = ifelse(mean_rating > 0.5, mean_rating, 1-mean_rating)
            )

df.main_questions_summary %>%
  filter(n_labels > 1) %>%
  group_by(task_name) %>%
  summarize(
    n_labels = round(mean(n_labels),0),
    mean_agreement = mean(agreement)
  )

df.main_questions_summary %>% select(task_name, question_name, agreement) %>%
  pivot_wider(names_from = question_name, values_from = agreement) %>%
  drop_na() %>%
  write_csv('per-task-per-q-agreement.csv')







# get_all_labels_as_matrix <- function(all_values){
#   return(matrix(as.numeric(str_split(all_values, '&')[[1]])))
# }

# TODO - this has a weird problem where it works if you filter a question and doesn't work otherwise
# df.main_questions_summary %>%
#   filter(n_labels > 1) %>%
#   mutate(
#     kripp.alpha = kripp.alpha(get_all_labels_as_matrix(all_values))$value
#   )

# Here is a hacky workaround
# df_multiple_labels_irr <- data.frame(matrix(nrow = 0, ncol = 5))
# for(i in 1:length(main_questions)){
# 
#   df_for_q <- df.main_questions_summary %>%
#     filter(question_name==main_questions[i]) %>%
#     filter(n_labels > 1) 
#   
#   if(nrow(df_for_q) > 0){
#       df_for_q <- df_for_q %>%
#         mutate(
#           kripp.alpha = kripp.alpha(get_all_labels_as_matrix(all_values))$value)
#   }
#   
#   df_multiple_labels_irr <- rbind(df_multiple_labels_irr, df_for_q)
# }
# df_multiple_labels_irr


# TODO - krippendorf's alpha is negative if even a small number of people disagree
# e.g., kripp.alpha(matrix(c(0,0,1,0,0,0,0,0,0,0,0,0,0,0))) = -0.071
```
Look at confidence

```{r, fig.width= 18}
p <- df.all_ratings_raw %>%
  filter(question_name %in% confidence_questions) %>%
  mutate(
    value = recode(value,
                   "Not at all confident" = "1",
                   "Not confident" = "2",
                   "Neutral" = "3",
                   "Confident" = "4",
                   "Very confident" ="5"
                   )
  ) %>%
  ggplot(
    aes(
      x = value,
      fill = task_name
    )
  ) +
  geom_bar() 

p + facet_wrap(~question_name, scales = "free")

ggsave('./question-confidence-analysis.png')
```












